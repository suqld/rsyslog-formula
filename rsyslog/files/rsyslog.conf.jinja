# Rsyslog Configuration File
#
# **** DO NOT EDIT THIS FILE ****
#
# This file is managed by Salt via {{ source }}
#
#
#  /etc/rsyslog.conf    Configuration file for rsyslog.
#
#                       For more information see
#                       /usr/share/doc/rsyslog-doc/html/rsyslog_conf.html


#################
#### MODULES ####
#################

module(load="imuxsock") # provides support for local system logging
{% if config.imkllog|default(true) %}
module(load="imklog")   # provides kernel logging support
{% endif %}
#module(load="immark")  # provides --MARK-- message capability

{% if config.listenudp|default(false) %}
# provides UDP syslog reception
module(load="imudp")
input(type="imudp" port="514")
{% endif %}

{% if config.listentcp|default(false) %}
# provides TCP syslog reception
module(load="imtcp")
input(type="imtcp" port="514")
{% endif %}

###########################
#### GLOBAL DIRECTIVES ####
###########################

#
# Use traditional timestamp format.
# To enable high precision timestamps, comment out the following line.
#
$ActionFileDefaultTemplate RSYSLOG_TraditionalFileFormat

#
# Set the default permissions for all log files.
#
{% if grains['os_family'] == 'Debian' %}
$FileOwner syslog
{% else %}
$FileOwner root
{% endif %}
$FileGroup adm
$FileCreateMode {{ config.get('filemode', '0640') }}
$DirCreateMode {{ config.get('dirmode', '0755') }}
$Umask 0022
{% if grains['os_family'] == 'Debian' %}
$PrivDropToUser syslog
$PrivDropToGroup syslog
{% endif %}

{% if config.logbasepath|default(false) %}
# If we are logging for other servers, log that to files first
$template DailyPerHostLogs,"{{ config.logbasepath }}/%HOSTNAME%_%FROMHOST-IP%.log"
*.* -?DailyPerHostLogs
{% endif %}

#
# Where to place spool and state files
#
$WorkDirectory /var/spool/rsyslog

#
# Include all config files in /etc/rsyslog.d/
#
$IncludeConfig /etc/rsyslog.d/*.conf

{% if config.target|default(false) %}
{% if config.protocol|default('udp') == 'tcp' %}
*.* @@{{ config.target }}
{% else %}
*.* @{{ config.target }}
{% endif %}
{% else %}
{% for target in config.get('targets', []) %}
$ActionQueueType LinkedList
$ActionQueueFileName {{ target }}
$ActionResumeRetryCount -1
$ActionQueueSaveOnShutdown on
{% if config.protocol|default('udp') == 'tcp' %}
*.* @@{{ target }}
{% else %}
*.* @{{ target }}
{% endif %}
{% endfor %}
{% endif %}


